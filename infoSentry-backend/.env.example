# ============================================
# infoSentry Backend 环境变量配置模板
# ============================================
# 复制此文件为 .env 并填入实际配置值
# cp .env.example .env
#
# 注意：生产环境必须修改所有 "changethis" 和敏感信息

# ============================================
# 应用基础配置
# ============================================
PROJECT_NAME=infoSentry
SERVER_PORT=8000
ENVIRONMENT=local  # local, staging, production
LOG_LEVEL=INFO
TIMEZONE=Asia/Shanghai

# API 路径配置
API_V1_STR=/api/v1
ROOTPATH=

# 安全配置
SECRET_KEY=  # 使用 openssl rand -hex 32 生成
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=120  # 2 hours
MAGIC_LINK_EXPIRE_MINUTES=30

# CORS 配置（逗号分隔的域名列表）
BACKEND_CORS_ORIGINS=http://localhost:3000,http://localhost:8000
FRONTEND_HOST=http://localhost:3000
BACKEND_HOST=http://localhost:8000

# ============================================
# PostgreSQL 数据库配置
# ============================================
POSTGRES_SERVER=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=  # 生产环境必须配置
POSTGRES_DB=infosentry

# ============================================
# Redis 配置
# ============================================
# DB 0: Celery Broker
# DB 1: Application Cache（Buffer/RateLimit/Config）
REDIS_URL=redis://localhost:6379/0

# ============================================
# Celery 配置
# ============================================
# 留空则使用 REDIS_URL
CELERY_BROKER_URL=
CELERY_RESULT_BACKEND=

# 序列化配置
CELERY_TASK_SERIALIZER=json
CELERY_RESULT_SERIALIZER=json

# 重试配置
CELERY_TASK_DEFAULT_RETRY_DELAY=60
CELERY_TASK_MAX_RETRIES=3

# Worker 并发配置（2c4g 推荐）
WORKER_INGEST_CONCURRENCY=2
WORKER_EMBED_CONCURRENCY=1
WORKER_MATCH_CONCURRENCY=1
WORKER_AGENT_CONCURRENCY=1
WORKER_EMAIL_CONCURRENCY=1

# ============================================
# SMTP 邮件配置
# ============================================
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=  # 生产环境必须配置！
SMTP_TLS=true
SMTP_SSL=false
EMAILS_FROM_EMAIL=
EMAILS_FROM_NAME=infoSentry
EMAIL_RESET_TOKEN_EXPIRE_HOURS=48

# ============================================
# OpenAI API 配置
# ============================================
OPENAI_API_KEY=  # 生产环境必须配置！
OPENAI_API_BASE=https://api.openai.com/v1
OPENAI_EMBED_MODEL=text-embedding-3-small
OPENAI_JUDGE_MODEL=gpt-4o-mini
EMBEDDING_DIMENSION=1536

# ============================================
# Feature Flags（降级开关）
# ============================================
LLM_ENABLED=true           # 关闭后边界判别全部降级 Batch
EMBEDDING_ENABLED=true     # 关闭后 embedding 跳过
IMMEDIATE_ENABLED=true     # 关闭后只有 Batch/Digest
EMAIL_ENABLED=true         # 关闭后只站内通知

# ============================================
# 预算控制配置
# ============================================
DAILY_USD_BUDGET=0.33      # 日预算（美元），月成本 ≤ $10
EMBED_PER_DAY=500          # 每日嵌入上限
EMBED_PER_MIN=300          # 每分钟嵌入上限
JUDGE_PER_DAY=200          # 每日判别上限

# ============================================
# 抓取（Ingest）配置
# ============================================
NEWSNOW_FETCH_INTERVAL_SEC=1800   # 30 分钟
RSS_FETCH_INTERVAL_SEC=900        # 15 分钟
SITE_FETCH_INTERVAL_SEC=1800      # 30 分钟
ITEMS_PER_SOURCE_PER_FETCH=20     # 单源单轮上限
INGEST_SOURCES_PER_MIN=60         # 源/分钟上限
INGEST_ERROR_BACKOFF_BASE=60      # 错误退避基础秒数
INGEST_ERROR_BACKOFF_MAX=3600     # 错误退避最大秒数（1小时）
INGEST_MAX_ERROR_STREAK=5         # 连续错误次数阈值告警

# ============================================
# 推送配置
# ============================================
# Immediate 合并配置
IMMEDIATE_COALESCE_MINUTES=5      # 合并窗口（分钟）
IMMEDIATE_MAX_ITEMS=3             # 单封邮件最大条目数

# Batch 配置
BATCH_MAX_ITEMS=8                 # 每次 Batch 最多条目数

# Digest 配置
DIGEST_MAX_ITEMS_PER_GOAL=10      # 每 Goal 最多条目数
DIGEST_SEND_HOUR=9                # 发送时间（小时，CST）

# 阈值配置
IMMEDIATE_THRESHOLD=0.93          # ≥0.93 直通 Immediate
BATCH_THRESHOLD=0.75              # 0.75~0.88 入 Batch
DIGEST_MIN_SCORE=0.60             # Digest 最低分数
BOUNDARY_LOW=0.88                 # LLM 判别边界区间下限
BOUNDARY_HIGH=0.93                # LLM 判别边界区间上限

# ============================================
# 监控配置（可选）
# ============================================
SENTRY_DSN=
