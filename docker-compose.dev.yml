# ============================================
# infoSentry 开发环境配置
# ============================================
# 适用于：本地开发和调试
#
# 使用方法:
#   启动所有服务: docker-compose -f docker-compose.dev.yml up -d
#   启动部分服务: docker-compose -f docker-compose.dev.yml up -d postgres redis api
#   查看日志: docker-compose -f docker-compose.dev.yml logs -f [service-name]
#   重建服务: docker-compose -f docker-compose.dev.yml up -d --build
#   停止服务: docker-compose.dev.yml down
#   停止并删除数据: docker-compose -f docker-compose.dev.yml down -v
#
# 特性：
#   - 所有端口暴露，便于本地访问
#   - 代码热重载，修改即生效
#   - 详细日志输出（DEBUG级别）
#   - 无资源限制，快速启动
#   - 可选服务，按需启动

version: '3.8'

x-common-env: &common-env
  POSTGRES_SERVER: postgres
  POSTGRES_PORT: 5432
  POSTGRES_USER: ${POSTGRES_USER:-postgres}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
  POSTGRES_DB: ${POSTGRES_DB:-infosentry}
  REDIS_URL: redis://redis:6379/0
  ENVIRONMENT: development
  TZ: Asia/Shanghai
  SECRET_KEY: ${SECRET_KEY:-dev-secret-key-please-change-in-production}
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
  OPENAI_EMBED_MODEL: ${OPENAI_EMBED_MODEL:-text-embedding-3-small}
  OPENAI_JUDGE_MODEL: ${OPENAI_JUDGE_MODEL:-gpt-4o-mini}
  SMTP_HOST: ${SMTP_HOST:-}
  SMTP_PORT: ${SMTP_PORT:-587}
  SMTP_USER: ${SMTP_USER:-}
  SMTP_PASSWORD: ${SMTP_PASSWORD:-}
  EMAILS_FROM_EMAIL: ${EMAILS_FROM_EMAIL:-}
  EMAILS_FROM_NAME: ${EMAILS_FROM_NAME:-infoSentry Dev}
  FRONTEND_HOST: ${FRONTEND_HOST:-http://localhost:3000}
  BACKEND_HOST: ${BACKEND_HOST:-http://localhost:8000}
  LLM_ENABLED: ${LLM_ENABLED:-true}
  EMBEDDING_ENABLED: ${EMBEDDING_ENABLED:-true}
  IMMEDIATE_ENABLED: ${IMMEDIATE_ENABLED:-true}
  EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
  DAILY_USD_BUDGET: ${DAILY_USD_BUDGET:-10.0}
  JUDGE_PER_DAY: ${JUDGE_PER_DAY:-1000}
  EMBED_PER_MIN: ${EMBED_PER_MIN:-1000}
  LOG_LEVEL: ${LOG_LEVEL:-DEBUG}

services:
  # ============================================
  # 数据存储层（必需）
  # ============================================

  postgres:
    image: pgvector/pgvector:pg16
    container_name: infosentry-dev-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-infosentry}
      TZ: Asia/Shanghai
    ports:
      - "${POSTGRES_PORT:-5432}:5432"  # 暴露端口，便于使用数据库工具连接
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - infosentry-dev

  redis:
    image: redis:7-alpine
    container_name: infosentry-dev-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --appendfsync everysec
    ports:
      - "${REDIS_PORT:-6379}:6379"  # 暴露端口，便于使用 Redis 工具连接
    volumes:
      - redis_dev_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - infosentry-dev

  # ============================================
  # 应用层（开发模式）
  # ============================================

  api:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-api
    restart: unless-stopped
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
    environment:
      <<: *common-env
    ports:
      - "${API_PORT:-8000}:8000"  # 暴露 API 端口
    volumes:
      - ./infoSentry-backend:/app  # 挂载代码目录，支持热重载
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    # 开发环境不设资源限制

  web:
    build:
      context: ./infosentry-web
      dockerfile: Dockerfile.dev
    container_name: infosentry-dev-web
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: ${BACKEND_HOST:-http://localhost:8000}
      NODE_ENV: development
    ports:
      - "${WEB_PORT:-3000}:3000"  # 暴露 Web 端口
    volumes:
      - ./infosentry-web:/app  # 挂载代码目录，支持热重载
      - /app/node_modules  # 排除 node_modules
      - /app/.next  # 排除 .next 构建目录
    depends_on:
      - api
    networks:
      - infosentry-dev

  # ============================================
  # Worker 层（可选，按需启动）
  # ============================================
  #
  # 启动所有 workers:
  #   docker-compose -f docker-compose.dev.yml up -d worker_ingest worker_embed_match worker_agent worker_email beat
  #
  # 或单独启动某个 worker:
  #   docker-compose -f docker-compose.dev.yml up -d worker_ingest

  worker_ingest:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-worker-ingest
    restart: unless-stopped
    command: uv run celery -A src.core.infrastructure.celery.app worker -Q q_ingest -c 2 -l DEBUG -n worker_ingest@%h
    environment:
      <<: *common-env
      CELERY_WORKER_NAME: worker_ingest
    volumes:
      - ./infoSentry-backend:/app  # 挂载代码目录
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    profiles:
      - workers  # 默认不启动，需要 --profile workers 参数

  worker_embed_match:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-worker-embed-match
    restart: unless-stopped
    command: uv run celery -A src.core.infrastructure.celery.app worker -Q q_embed,q_match -c 1 -l DEBUG -n worker_embed_match@%h
    environment:
      <<: *common-env
      CELERY_WORKER_NAME: worker_embed_match
    volumes:
      - ./infoSentry-backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    profiles:
      - workers

  worker_agent:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-worker-agent
    restart: unless-stopped
    command: uv run celery -A src.core.infrastructure.celery.app worker -Q q_agent -c 1 -l DEBUG -n worker_agent@%h
    environment:
      <<: *common-env
      CELERY_WORKER_NAME: worker_agent
    volumes:
      - ./infoSentry-backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    profiles:
      - workers

  worker_email:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-worker-email
    restart: unless-stopped
    command: uv run celery -A src.core.infrastructure.celery.app worker -Q q_email -c 1 -l DEBUG -n worker_email@%h
    environment:
      <<: *common-env
      CELERY_WORKER_NAME: worker_email
    volumes:
      - ./infoSentry-backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    profiles:
      - workers

  beat:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-beat
    restart: unless-stopped
    command: uv run celery -A src.core.infrastructure.celery.app beat -l DEBUG
    environment:
      <<: *common-env
    volumes:
      - ./infoSentry-backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    profiles:
      - workers

  # ============================================
  # 开发工具（可选）
  # ============================================

  # Redis 管理界面
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: infosentry-dev-redis-ui
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "${REDIS_UI_PORT:-8081}:8081"
    depends_on:
      - redis
    networks:
      - infosentry-dev
    profiles:
      - tools

  # PostgreSQL 管理界面
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: infosentry-dev-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@infosentry.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_dev_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - infosentry-dev
    profiles:
      - tools

  # Flower - Celery 监控界面
  flower:
    build:
      context: ./infoSentry-backend
      dockerfile: Dockerfile
    container_name: infosentry-dev-flower
    restart: unless-stopped
    command: uv run celery -A src.core.infrastructure.celery.app flower --port=5555
    environment:
      <<: *common-env
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    volumes:
      - ./infoSentry-backend:/app
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - infosentry-dev
    profiles:
      - tools

volumes:
  postgres_dev_data:
    name: infosentry-dev-postgres-data
  redis_dev_data:
    name: infosentry-dev-redis-data
  pgadmin_dev_data:
    name: infosentry-dev-pgadmin-data

networks:
  infosentry-dev:
    name: infosentry-dev-network
    driver: bridge
